default:
  image: python:3.11
  before_script:
    - python -m pip install --upgrade pip
    - pip install --upgrade hatch nox
    - hatch env create
  cache:
    key: "$CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .cache/pip
      - .cache/.config/hatch
      - .venv
      - .pytest_cache
      - .ruff_cache
      - .mypy_cache

stages:
  - quality
  - test
  - coverage
  - secret-detection

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  HATCH_CACHE_DIR: "$CI_PROJECT_DIR/.cache/.config/hatch"
  SECRET_DETECTION_ENABLED: "true"

quality:fmt:
  stage: quality
  script:
    - hatch run fmt
    - git diff --stat || true
    - git diff --exit-code

quality:lint:
  stage: quality
  script:
    - hatch run lint

unit:asr:
  stage: test
  script:
    - mkdir -p reports
    - hatch run test-asr -- --disable-warnings --maxfail=1 --junitxml=reports/unit-asr.xml
  artifacts:
    when: always
    reports:
      junit: reports/unit-asr.xml
    paths:
      - reports/unit-asr.xml
    expire_in: 1 week

unit:tts:
  stage: test
  script:
    - mkdir -p reports
    - hatch run test-tts -- --disable-warnings --maxfail=1 --junitxml=reports/unit-tts.xml
  artifacts:
    when: always
    reports:
      junit: reports/unit-tts.xml
    paths:
      - reports/unit-tts.xml
    expire_in: 1 week

unit:core:
  stage: test
  script:
    - mkdir -p reports
    - hatch run test-core -- --disable-warnings --maxfail=1 --junitxml=reports/unit-core.xml
  artifacts:
    when: always
    reports:
      junit: reports/unit-core.xml
    paths:
      - reports/unit-core.xml
    expire_in: 1 week

unit:utils:
  stage: test
  script:
    - mkdir -p reports
    - hatch run test-utils -- --disable-warnings --maxfail=1 --junitxml=reports/unit-utils.xml
  artifacts:
    when: always
    reports:
      junit: reports/unit-utils.xml
    paths:
      - reports/unit-utils.xml
    expire_in: 1 week

integration:
  stage: test
  script:
    - mkdir -p reports
    - hatch run test-integration -- --disable-warnings --maxfail=1 --junitxml=reports/integration.xml
  artifacts:
    when: always
    reports:
      junit: reports/integration.xml
    paths:
      - reports/integration.xml
    expire_in: 1 week

coverage:report:
  stage: coverage
  needs:
    - unit:asr
    - unit:tts
    - unit:core
    - unit:utils
    - integration
  script:
    - mkdir -p reports
    - hatch run cov -- --disable-warnings --maxfail=1 --junitxml=reports/unit-all.xml
  coverage: '/^TOTAL\s+\d+\s+\d+\s+(\d+\%)$/'
  artifacts:
    when: always
    reports:
      junit: reports/unit-all.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
      - htmlcov/
      - .coverage
      - reports/unit-all.xml
    expire_in: 1 week

secret_detection:
  stage: secret-detection
  before_script: []

include:
  - template: Security/Secret-Detection.gitlab-ci.yml
